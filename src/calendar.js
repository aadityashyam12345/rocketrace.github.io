"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var selectedGrade=null,generatedCalendar=null;function loadFile(e){var t=new XMLHttpRequest;return t.open("GET",e,!1),t.send(),200==t.status?t.response:(console.log("Failed to GET content of ".concat(e)),null)}function leftPad(e,t,n){if(e.length>=n)return e;for(var a=n-e.length,o=[],r=0;r<a;r++)o.push(t);return o.push(e),o.join("")}function copyDate(e){return new Date(e.getFullYear(),e.getMonth(),e.getDate())}function fmtDate(e){var t=e.getFullYear(),n=e.getMonth()+1,a=e.getDate(),o=e.getHours(),r=e.getMinutes(),d=e.getSeconds(),l=leftPad(n.toString(),"0",2),s=leftPad(a.toString(),"0",2),c=leftPad(o.toString(),"0",2),i=leftPad(r.toString(),"0",2),u=leftPad(d.toString(),"0",2);return"".concat(t).concat(l).concat(s,"T").concat(c).concat(i).concat(u)}function dayKey(e){return"".concat(e.weekDay,"-").concat(e.rotationDay)}function bridgeDay(e,t,n){var a=e.split(","),o=t.indexOf(a[0].substring(1,a[0].length-1))+(n?0:9),r=a[1].substring(1,a[1].length-1).split("/"),d=new Date(Number(r[2]),Number(r[0])-1,Number(r[1]));return{rotationDay:o,weekDay:d.getDay()-1,date:d}}var Lesson=function e(t,n,a,o){_classCallCheck(this,e),this.id=t,this.label=n,this.startTime=a,this.endTime=o};function makeIcal(e){var t=[];t.push("BEGIN:VCALENDAR"),t.push("VERSION:2.0"),t.push("PRODID:-//RocketRace//CA Calendar Generator//EN"),t.push("X-WR-CALNAME:Lesson Rotation"),t.push("BEGIN:VTIMEZONE"),t.push("TZID:Asia/Tokyo"),t.push("BEGIN:STANDARD"),t.push("DTSTART:20200815T000000"),t.push("TZOFFSETO:+0900"),t.push("TZOFFSETFROM:+0900"),t.push("END:STANDARD"),t.push("END:VTIMEZONE");var n=0,a=fmtDate(new Date);return e.forEach(function(e){t.push(makeEventIcal(e,a,n)),n+=1}),t.push("END:VCALENDAR"),t.join("\r\n")}function makeEventIcal(e,t,n){var a=[];return a.push("BEGIN:VEVENT"),a.push("UID:".concat(t,"_").concat(n,"@rocketrace.github.io")),a.push("DTSTAMP:".concat(t)),a.push("DTSTART:".concat(fmtDate(e.startTime))),a.push("DTEND:".concat(fmtDate(e.endTime))),a.push("SUMMARY:".concat(e.label)),a.push("CATEGORIES:Period ".concat(e.id)),a.push("END:VEVENT"),a.join("\r\n")}function makeCalendar(c,i,u){var e=loadFile("/src/data/calendar.csv"),t=loadFile("/src/data/times.json"),n=loadFile("/src/data/rotation.json");if(null===e||null===t||null===n)return console.error("Failed to make request"),alert("Could not load the calendar data! Try again later."),null;var a=e.substring(e.indexOf("\n")+1).split("\n"),h=JSON.parse(t),m=JSON.parse(n),g=[],p=!0;a.forEach(function(e){var t=bridgeDay(e,m.days,p);console.log(t),8!==t.rotationDay&&17!==t.rotationDay||(p=!p,console.log("toggled"));dayKey(t);for(var n=0;n<m[c][t.rotationDay].length;n++){var a,o=m[c][t.rotationDay][n],r=void 0===o.time?h[c][t.weekDay][n]:o.time,d=copyDate(t.date),l=copyDate(t.date);d.setHours(r.startHours,r.startMinutes,0,0),void 0!==o.hlExtension&&!0===u[o.id]?(a=60<=r.endMinutes+o.hlExtension.minutes,l.setHours(r.endHours+o.hlExtension.hours+(a?1:0),(r.endMinutes+o.hlExtension.minutes)%60)):l.setHours(r.endHours,r.endMinutes,0,0);var s=o.special?o.label:i[o.id];""!==s&&g.push(new Lesson(o.id,s,d,l))}});var o=makeIcal(g);return console.log("Generated iCal calendar contents."),o}function download(e,t){var n=document.createElement("a");n.setAttribute("href","data:text/ics;charset=utf-8,"+encodeURIComponent(t)),n.setAttribute("download",e),n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n)}function generateLessons(e){document.getElementById("gradeState").hidden=!0,document.getElementById("lessonsState").hidden=!1,"dp"!==e&&"other"!==e||(document.getElementById("lessonNotice").textContent+="Check each checkbox next to the class if it is an HL class!");var t=loadFile("/src/data/keys.json");if(null===t)return console.error("Failed to make request"),void alert("Could not load the calendar data! Try again later.");var n,a,o,r,d=JSON.parse(t),l=document.getElementById("lessonInputs");for(var s in d){Object.prototype.hasOwnProperty.call(d,s)&&(n=d[s],(a=document.createElement("input")).id="lesson_name_".concat(s),a.type="text",a.placeholder=n,a.size=20,a.maxLength=1e3,l.appendChild(a),"dp"!==e&&"other"!==e||((o=document.createElement("em")).textContent="   HL?",(r=document.createElement("input")).id="lesson_hl_".concat(s),r.type="checkbox",l.appendChild(o),l.appendChild(r)),l.appendChild(document.createElement("br")))}}function generateDownload(){document.getElementById("lessonsState").hidden=!0,document.getElementById("downloadState").hidden=!1}function showGradeError(e){document.getElementById("gradeRequiredError").hidden=e}function submitGrade(){var e=document.getElementById("gradeInput").value;""===e?showGradeError(!1):(showGradeError(!0),generateLessons(selectedGrade=e))}function submitLessons(){for(var e=document.getElementById("lessonInputs").children,t={},n={},a=0;a<e.length;a++){var o,r=e[a];"INPUT"===r.tagName&&((o=r).id.startsWith("lesson_name_")?t[o.id.substring(12)]=o.value?o.value:"":o.id.startsWith("lesson_hl_")&&(n[o.id.substring(10)]=o.checked))}return null===selectedGrade?(console.error("Somehow the selected grade is not valid?"),void alert("Something went wrong! Refresh and try again.")):null===(generatedCalendar=makeCalendar(selectedGrade,t,n))?(console.error("Calendar could not be generated."),void alert("Could not generate a calendar. Please refresh and try again!")):void generateDownload()}function downloadCalendar(){null!==generatedCalendar?download("calendar.ics",generatedCalendar):console.error("A calendar was not properly generated")}function init(){document.getElementById("gradeSubmit").onclick=submitGrade,document.getElementById("lessonsSubmit").onclick=submitLessons,document.getElementById("downloadCalendar").onclick=downloadCalendar}window.onload=init;