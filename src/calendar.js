"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function loadFile(t){var e=new XMLHttpRequest;return e.open("GET",t,!1),e.send(),200==e.status?e.response:(console.log("Failed to GET content of ".concat(t)),null)}function leftPad(t,e,n){if(t.length>=n)return t;for(var a=n-t.length,o=[],s=0;s<a;s++)o.push(e);return o.push(t),o.join("")}function copyDate(t){return new Date(t.getFullYear(),t.getMonth(),t.getDate())}function fmtDate(t){var e=t.getFullYear(),n=t.getMonth()+1,a=t.getDate(),o=t.getHours(),s=t.getMinutes(),r=t.getSeconds(),c=leftPad(n.toString(),"0",2),i=leftPad(a.toString(),"0",2),l=leftPad(o.toString(),"0",2),u=leftPad(s.toString(),"0",2),d=leftPad(r.toString(),"0",2);return"".concat(e).concat(c).concat(i,"T").concat(l).concat(u).concat(d)}function dayKey(t){return"".concat(t.weekDay,"-").concat(t.rotationDay)}function bridgeDay(t,e,n){var a=t.split(","),o=e.indexOf(a[0].substring(1,a[0].length-1))+(n?0:9),s=a[1].substring(1,a[1].length-1).split("/"),r=new Date(Number(s[2]),Number(s[0])-1,Number(s[1]));return{rotationDay:o,weekDay:r.getDay()-1,date:r}}var Lesson=function t(e,n,a,o){_classCallCheck(this,t),this.id=e,this.label=n,this.startTime=a,this.endTime=o};function makeIcal(t){var e=[];e.push("BEGIN:VCALENDAR"),e.push("VERSION:2.0"),e.push("PRODID:-//RocketRace//CA Calendar Generator//EN"),e.push("X-WR-CALNAME:Lesson Rotation"),e.push("BEGIN:VTIMEZONE"),e.push("TZID:Asia/Tokyo"),e.push("BEGIN:STANDARD"),e.push("DTSTART:20200815T000000"),e.push("TZOFFSETO:+0900"),e.push("TZOFFSETFROM:+0900"),e.push("END:STANDARD"),e.push("END:VTIMEZONE");var n=0,a=fmtDate(new Date);return t.forEach(function(t){e.push(makeEventIcal(t,a,n)),n+=1}),e.push("END:VCALENDAR"),e.join("\r\n")}function makeEventIcal(t,e,n){var a=[];return a.push("BEGIN:VEVENT"),a.push("UID:".concat(e,"_").concat(n,"@rocketrace.github.io")),a.push("DTSTAMP:".concat(e)),a.push("DTSTART:".concat(fmtDate(t.startTime))),a.push("DTEND:".concat(fmtDate(t.endTime))),a.push("SUMMARY:".concat(t.label)),a.push("CATEGORIES:Period ".concat(t.id)),a.push("END:VEVENT"),a.join("\r\n")}function makeCalendar(l,u){var t=loadFile("/src/data/calendar.csv"),e=loadFile("/src/data/times.json"),n=loadFile("/src/data/rotation.json");if(null===t||null===e||null===n)return alert("Could not load the calendar data! Try again later."),null;var a=t.substring(t.indexOf("\n")+1).split("\n"),d=JSON.parse(e),h=JSON.parse(n),D=[],p={},f=!0;a.forEach(function(t){var e=bridgeDay(t,h.days,f);e.rotationDay in[8,17]&&(f=!f);var n=dayKey(e);if(void 0===p[n])for(var a=0;a<h[l][e.rotationDay].length;a++){var o=h[l][e.rotationDay][a],s=void 0===o.time?d[l][e.weekDay][a]:o.time,r=copyDate(e.date),c=copyDate(e.date);r.setHours(s.startHours,s.startMinutes,0,0),c.setHours(s.endHours,s.endMinutes,0,0);var i="",i=o.special?o.label:u[o.id];D.push(new Lesson(o.id,i,r,c))}else D.concat(p[n])});var o=makeIcal(D);return console.log("Generated iCal calendar contents."),console.log(o),saveResult(o),o}function saveResult(t){var e=document.getElementById("calendar-result");null!==e?e.innerHTML=t:console.log("Could not find div with id 'calendar-result'")}function download(t,e){var n=document.createElement("a");n.setAttribute("href","data:text/ics;charset=utf-8,"+encodeURIComponent(e)),n.setAttribute("download",t),n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n)}var choices={A:"Lesson A",B:"Lesson B",C:"Lesson C",D:"Lesson D",E:"Lesson E",F:"Lesson F",G:"Lesson G",H:"Lesson H"};function init(){makeCalendar("dp",choices)}window.onload=init;